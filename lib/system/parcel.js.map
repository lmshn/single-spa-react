{"version":3,"file":"parcel.js","sources":["../../src/parcel.js"],"sourcesContent":["/* This import statement requires a peer or dev dependency on react that is fulfilled at runtime.\r\n * To avoid duplicate bundling of react, we do not do this inside of single-spa-react.js.\r\n * We also do not set up the prop types in this file to avoid requiring the user of the library\r\n * to have prop-types installed and in their browser bundle, since not everyone uses prop types.\r\n */\r\nimport { SingleSpaContext } from \"single-spa-react\";\r\nimport * as React from \"react\";\r\n\r\nexport default class Parcel extends React.Component {\r\n  static defaultProps = {\r\n    wrapWith: \"div\",\r\n    wrapStyle: {},\r\n    parcelDidMount: () => {},\r\n  };\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.state = {\r\n      hasError: false,\r\n    };\r\n\r\n    if (!props.config) {\r\n      throw new Error(\r\n        `single-spa-react's Parcel component requires the 'config' prop to either be a parcel config or a loading function that returns a promise. See https://github.com/single-spa/single-spa-react`\r\n      );\r\n    }\r\n  }\r\n  componentDidMount() {\r\n    this.addThingToDo(\"mount\", () => {\r\n      const mountParcel = this.props.mountParcel || this.mountParcel;\r\n      if (!mountParcel) {\r\n        throw new Error(`\r\n\t\t\t\t  <Parcel /> was not passed a mountParcel prop, nor is it rendered where mountParcel is within the React context.\r\n\t\t\t\t  If you are using <Parcel /> within a module that is not a single-spa application, you will need to import mountRootParcel from single-spa and pass it into <Parcel /> as a mountParcel prop\t\r\n\t\t\t\t`);\r\n      }\r\n      let domElement;\r\n      if (this.el) {\r\n        domElement = this.el;\r\n      } else {\r\n        this.createdDomElement = domElement = document.createElement(\r\n          this.props.wrapWith\r\n        );\r\n        Object.keys(this.props.wrapStyle).forEach((key) => {\r\n          domElement.style[key] = this.props.wrapStyle[key];\r\n        });\r\n        this.props.appendTo.appendChild(domElement);\r\n      }\r\n      this.parcel = mountParcel(this.props.config, {\r\n        domElement,\r\n        ...this.getParcelProps(),\r\n      });\r\n      this.parcel.mountPromise.then(this.props.parcelDidMount);\r\n      return this.parcel.mountPromise;\r\n    });\r\n  }\r\n  componentDidUpdate() {\r\n    this.addThingToDo(\"update\", () => {\r\n      if (this.parcel && this.parcel.update) {\r\n        return this.parcel.update(this.getParcelProps());\r\n      }\r\n    });\r\n  }\r\n  componentWillUnmount() {\r\n    this.addThingToDo(\"unmount\", () => {\r\n      if (this.parcel && this.parcel.getStatus() === \"MOUNTED\") {\r\n        return this.parcel.unmount();\r\n      }\r\n    });\r\n\r\n    if (this.createdDomElement) {\r\n      this.createdDomElement.parentNode.removeChild(this.createdDomElement);\r\n    }\r\n\r\n    this.unmounted = true;\r\n  }\r\n  render() {\r\n    if (this.props.appendTo) {\r\n      if (SingleSpaContext && SingleSpaContext.Consumer) {\r\n        return (\r\n          <SingleSpaContext.Consumer>\r\n            {(context) => {\r\n              this.mountParcel = context ? context.mountParcel : null;\r\n\r\n              return null;\r\n            }}\r\n          </SingleSpaContext.Consumer>\r\n        );\r\n      } else {\r\n        return null;\r\n      }\r\n    } else {\r\n      const children =\r\n        SingleSpaContext && SingleSpaContext.Consumer ? (\r\n          <SingleSpaContext.Consumer>\r\n            {(context) => {\r\n              this.mountParcel = context ? context.mountParcel : null;\r\n\r\n              return null;\r\n            }}\r\n          </SingleSpaContext.Consumer>\r\n        ) : undefined;\r\n\r\n      return React.createElement(\r\n        this.props.wrapWith,\r\n        {\r\n          ref: this.handleRef,\r\n          style: this.props.wrapStyle,\r\n          className: this.props.wrapClassName,\r\n        },\r\n        children\r\n      );\r\n    }\r\n  }\r\n  handleRef = (el) => {\r\n    this.el = el;\r\n  };\r\n  addThingToDo = (action, thing) => {\r\n    if (this.state.hasError && action !== \"unmount\") {\r\n      // In an error state, we don't do anything anymore except for unmounting\r\n      return;\r\n    }\r\n\r\n    this.nextThingToDo = (this.nextThingToDo || Promise.resolve())\r\n      .then((...args) => {\r\n        if (this.unmounted && action !== \"unmount\") {\r\n          // Never do anything once the react component unmounts\r\n          return;\r\n        }\r\n\r\n        return thing(...args);\r\n      })\r\n      .catch((err) => {\r\n        this.nextThingToDo = Promise.resolve(); // reset so we don't .then() the bad promise again\r\n        this.setState({ hasError: true });\r\n\r\n        if (err && err.message) {\r\n          err.message = `During '${action}', parcel threw an error: ${err.message}`;\r\n        }\r\n\r\n        if (this.props.handleError) {\r\n          this.props.handleError(err);\r\n        } else {\r\n          setTimeout(() => {\r\n            throw err;\r\n          });\r\n        }\r\n\r\n        // No more things to do should be done -- the parcel is in an error state\r\n        throw err;\r\n      });\r\n  };\r\n  getParcelProps = () => {\r\n    // Make sure domElement is a prop, so that the parcel updates the correct domEl rather than creating a new one\r\n    const parcelProps = { ...this.props, domElement: this.el };\r\n\r\n    delete parcelProps.mountParcel;\r\n    delete parcelProps.config;\r\n    delete parcelProps.wrapWith;\r\n    delete parcelProps.wrapStyle;\r\n    delete parcelProps.appendTo;\r\n    delete parcelProps.handleError;\r\n    delete parcelProps.parcelDidMount;\r\n\r\n    return parcelProps;\r\n  };\r\n}\r\n"],"names":["Parcel","exports","_React$Component","_inherits","_super","_createSuper","props","_this","_classCallCheck","_defineProperty","_assertThisInitialized","call","el","action","thing","state","hasError","nextThingToDo","Promise","resolve","then","unmounted","apply","arguments","catch","err","setState","message","concat","handleError","setTimeout","parcelProps","_objectSpread","domElement","mountParcel","config","wrapWith","wrapStyle","appendTo","parcelDidMount","Error","key","value","_this2","this","addThingToDo","createdDomElement","document","createElement","Object","keys","forEach","style","appendChild","parcel","getParcelProps","mountPromise","_this3","update","_this4","getStatus","unmount","parentNode","removeChild","_this5","SingleSpaContext","Consumer","React","context","children","undefined","ref","handleRef","className","wrapClassName","Component"],"mappings":"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"}